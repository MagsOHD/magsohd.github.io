<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email Automatique - Portfolio Lucas Bracq</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00fff9;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(0, 255, 249, 0.1);
            border: 2px solid #00fff9;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-weight: bold;
        }
        .success { background: rgba(57, 255, 20, 0.2); color: #39ff14; }
        .error { background: rgba(255, 107, 0, 0.2); color: #ff6b00; }
        .warning { background: rgba(255, 255, 0, 0.2); color: #ffff00; }
        .info { background: rgba(0, 255, 249, 0.2); color: #00fff9; }
        .log-container {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #ff00ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 3px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }
        .test-btn {
            background: transparent;
            border: 2px solid #ff00ff;
            color: #ff00ff;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }
        .test-btn:hover {
            background: #ff00ff;
            color: #0a0a0a;
        }
        .counter {
            font-size: 2em;
            text-align: center;
            color: #39ff14;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Email Automatique - Portfolio Cyberpunk</h1>

        <div class="test-section">
            <h2>üìß Test d'Envoi Automatique</h2>
            <p><strong>Email cible:</strong> lucas.bracq.pro+notifSite@gmail.com</p>
            <p><strong>Objectif:</strong> V√©rifier que l'email est envoy√© automatiquement √† chaque nouvelle visite</p>

            <div class="counter" id="countdown">
                Initialisation en cours...
            </div>

            <div id="status-container">
                <div class="status info">üîÑ Chargement des services...</div>
            </div>

            <button class="test-btn" onclick="forceEmailTest()">üöÄ Forcer Test Email</button>
            <button class="test-btn" onclick="validateWeb3Forms()">üîë Valider Web3Forms</button>
            <button class="test-btn" onclick="testEmailSending()">üß™ Test Simple</button>
            <button class="test-btn" onclick="resetSession()">üîÑ Reset Session</button>
            <button class="test-btn" onclick="checkEmailService()">üîç V√©rifier Service</button>
        </div>

        <div class="test-section">
            <h2>üìä Logs en Temps R√©el</h2>
            <div id="log-container" class="log-container">
                <div class="info">[INIT] D√©marrage du test d'email automatique...</div>
            </div>
            <button class="test-btn" onclick="clearLogs()">üóëÔ∏è Effacer Logs</button>
        </div>

        <div class="test-section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div id="config-info">
                <div class="warning">‚è≥ V√©rification de la configuration...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Instructions</h2>
            <ol>
                <li><strong>Service utilis√© :</strong> Web3Forms uniquement (EmailJS supprim√©)</li>
                <li><strong>Configuration :</strong> Cl√© Web3Forms d√©j√† configur√©e</li>
                <li><strong>Test de validation :</strong> Cliquez "üîë Valider Web3Forms"</li>
                <li><strong>Test d'envoi :</strong> Cliquez "üöÄ Forcer Test Email"</li>
                <li><strong>V√©rifiez votre bo√Æte mail :</strong> lucas.bracq.pro@gmail.com</li>
            </ol>
        </div>
    </div>

    <!-- Error Handler -->
    <script src="errorHandler.js"></script>

    <!-- Notification Service -->
    <script src="ntfy-config.js"></script>
    <script src="emailService.js"></script>

    <script>
        let testStartTime = Date.now();
        let countdownTimer;
        let logCount = 0;

        // Enhanced logging avec timestamp
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            logCount++;

            // Limiter √† 100 logs
            if (logCount > 100) {
                logContainer.removeChild(logContainer.firstChild);
                logCount--;
            }
        }

        // Mise √† jour du statut
        function updateStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            statusContainer.appendChild(status);

            // Garder seulement les 5 derniers statuts
            while (statusContainer.children.length > 5) {
                statusContainer.removeChild(statusContainer.firstChild);
            }
        }

        // Countdown pour l'auto-test
        function startCountdown() {
            let seconds = 5;
            const countdownEl = document.getElementById('countdown');

            countdownTimer = setInterval(() => {
                if (seconds > 0) {
                    countdownEl.textContent = `Auto-test dans ${seconds} secondes...`;
                    seconds--;
                } else {
                    countdownEl.textContent = 'üöÄ Lancement auto-test !';
                    clearInterval(countdownTimer);
                    runAutoEmailTest();
                }
            }, 1000);
        }

        // Test automatique d'email
        function runAutoEmailTest() {
            addLog('üéØ D√©marrage du test automatique d\'email', 'info');
            updateStatus('üöÄ Test automatique en cours...', 'warning');

            // V√©rifier que emailService est disponible
            if (!window.emailService) {
                addLog('‚ùå ERREUR: emailService non disponible!', 'error');
                updateStatus('‚ùå EmailService non trouv√©', 'error');
                return;
            }

            addLog('‚úÖ EmailService trouv√©', 'success');

            // Cr√©er des donn√©es de visiteur de test
            const testVisitorData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                referrer: 'Test automatique',
                language: 'fr',
                screenResolution: `${screen.width}x${screen.height}`,
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                pageUrl: window.location.href,
                pageTitle: 'üß™ Test Email Automatique',
                testMode: true
            };

            addLog('üìä Donn√©es de test cr√©√©es', 'info');

            // Envoyer l'email de test
            window.emailService.sendVisitorNotification(testVisitorData)
                .then(result => {
                    if (result && result.success) {
                        addLog(`üéâ EMAIL ENVOY√â AVEC SUCC√àS via ${result.service}!`, 'success');
                        updateStatus(`‚úÖ Email envoy√© via ${result.service}`, 'success');

                        document.getElementById('countdown').textContent = '‚úÖ Test r√©ussi !';
                        document.getElementById('countdown').style.color = '#39ff14';
                    } else {
                        addLog('‚ö†Ô∏è √âchec de l\'envoi d\'email', 'warning');
                        updateStatus('‚ö†Ô∏è √âchec envoi email', 'warning');
                        addLog(`D√©tails: ${JSON.stringify(result)}`, 'warning');
                    }
                })
                .catch(error => {
                    addLog(`‚ùå ERREUR lors de l'envoi: ${error.message}`, 'error');
                    updateStatus('‚ùå Erreur envoi email', 'error');
                    console.error('Erreur test email:', error);
                });
        }

        // Forcer un test manuel
        function forceEmailTest() {
            addLog('üîß Test manuel forc√©', 'info');
            runAutoEmailTest();
        }

        // Valider la configuration Web3Forms
        async function validateWeb3Forms() {
            addLog('üîë Validation de Web3Forms...', 'info');
            updateStatus('üîç Validation Web3Forms...', 'info');

            if (!window.emailService) {
                addLog('‚ùå EmailService non disponible', 'error');
                updateStatus('‚ùå EmailService manquant', 'error');
                return;
            }

            try {
                const validation = await window.emailService.validateWeb3FormsKey();

                if (validation.valid) {
                    addLog('‚úÖ Cl√© Web3Forms VALIDE!', 'success');
                    updateStatus('‚úÖ Web3Forms configur√©', 'success');
                } else {
                    addLog(`‚ùå Cl√© Web3Forms INVALIDE: ${validation.message}`, 'error');
                    updateStatus('‚ùå Cl√© Web3Forms invalide', 'error');
                }

                addLog(`D√©tails: ${JSON.stringify(validation)}`, 'info');
            } catch (error) {
                addLog(`üí• Erreur validation: ${error.message}`, 'error');
                updateStatus('üí• Erreur validation', 'error');
            }
        }

        // Test simple d'envoi d'email
        async function testEmailSending() {
            addLog('üß™ Test simple d\'envoi d\'email...', 'info');
            updateStatus('üß™ Test en cours...', 'info');

            if (!window.emailService) {
                addLog('‚ùå EmailService non disponible', 'error');
                updateStatus('‚ùå EmailService manquant', 'error');
                return;
            }

            try {
                const result = await window.emailService.testEmailSending();

                if (result && result.success) {
                    addLog(`üéâ TEST EMAIL R√âUSSI via ${result.service}!`, 'success');
                    updateStatus('‚úÖ Test r√©ussi', 'success');
                } else {
                    addLog('‚ö†Ô∏è Test √©chou√© - voir d√©tails dans la console', 'warning');
                    updateStatus('‚ö†Ô∏è Test √©chou√©', 'warning');
                }
            } catch (error) {
                addLog(`‚ùå Erreur test: ${error.message}`, 'error');
                updateStatus('‚ùå Test √©chou√©', 'error');
                console.error('Erreur compl√®te:', error);
            }
        }

        // Reset de la session
        function resetSession() {
            sessionStorage.clear();
            localStorage.removeItem('visitor-tracked');
            addLog('üîÑ Session reset - prochain chargement sera track√© comme nouvelle visite', 'info');
            updateStatus('üîÑ Session reset', 'info');
        }

        // V√©rifier le service email
        function checkEmailService() {
            addLog('üîç V√©rification du service email...', 'info');

            if (window.emailService) {
                const config = window.emailService.checkConfiguration();
                addLog('‚úÖ EmailService disponible', 'success');
                addLog(`Configuration: ${JSON.stringify(config)}`, 'info');

                updateStatus('‚úÖ EmailService OK', 'success');

                // Afficher la configuration
                const configInfo = document.getElementById('config-info');
                configInfo.innerHTML = `
                    <div class="success">‚úÖ EmailService charg√©</div>
                    <div class="${config.web3forms ? 'success' : 'error'}">
                        ${config.web3forms ? '‚úÖ' : '‚ùå'} Web3Forms: ${config.web3forms ? 'Configur√©' : 'Non configur√©'}
                    </div>
                    <div class="${config.fetch ? 'success' : 'error'}">
                        ${config.fetch ? '‚úÖ' : '‚ùå'} Fetch API: ${config.fetch ? 'Disponible' : 'Non disponible'}
                    </div>
                    <div class="${config.online ? 'success' : 'error'}">
                        ${config.online ? '‚úÖ' : '‚ùå'} Connexion: ${config.online ? 'En ligne' : 'Hors ligne'}
                    </div>
                    <div class="info">‚ÑπÔ∏è Service utilis√©: Web3Forms uniquement</div>
                `;
            } else {
                addLog('‚ùå EmailService non disponible!', 'error');
                updateStatus('‚ùå EmailService manquant', 'error');

                document.getElementById('config-info').innerHTML = `
                    <div class="error">‚ùå EmailService non charg√©</div>
                    <div class="warning">‚ö†Ô∏è V√©rifiez que emailService.js est bien inclus</div>
                `;
            }
        }

        // Effacer les logs
        function clearLogs() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '<div class="info">[CLEAR] Logs effac√©s</div>';
            logCount = 1;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Page de test charg√©e', 'info');
            updateStatus('üîÑ Initialisation...', 'info');

            // Attendre que tous les scripts soient charg√©s
            setTimeout(() => {
                checkEmailService();
                addLog('‚è±Ô∏è D√©marrage du countdown pour auto-test', 'info');
                startCountdown();
            }, 1000);
        });

        // Test si l'email est envoy√© automatiquement par le syst√®me normal
        window.addEventListener('load', function() {
            addLog('üåê Window loaded - V√©rification si syst√®me normal s\'active...', 'info');

            // √âcouter les notifications de succ√®s
            const originalShowNotification = window.showNotification;
            if (typeof originalShowNotification === 'function') {
                window.showNotification = function(message) {
                    addLog(`üì¢ Notification: ${message}`, 'info');
                    return originalShowNotification(message);
                };
            }
        });

        // Surveiller les erreurs
        window.addEventListener('error', function(e) {
            addLog(`üí• Erreur JS: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            addLog(`üí• Promise rejet√©e: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>